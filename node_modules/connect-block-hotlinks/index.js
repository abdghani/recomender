// Generated by CoffeeScript 1.9.1
var stripSubdomains, url;

url = require('url');

stripSubdomains = function(host) {
  host = host.split('.');
  if (host.length > 2) {
    host = host.slice(-2);
  }
  return host = host.join('.');
};

module.exports = function(req, res, next) {
  var host, referer;
  host = req.hostname;
  if (host == null) {
    return res.status(403).send("Missing 'Host' HTTP Header");
  }
  host = stripSubdomains(host);
  referer = req.get('Referer');
  if (referer == null) {
    return res.status(403).send("Missing 'Referer' HTTP Header");
  }
  try {
    referer = url.parse(referer);
  } catch (_error) {
    return next(Error("url.parse(" + referer + ") throws error"));
  }
  referer = stripSubdomains(referer.hostname);
  if (referer !== host) {
    return res.status(200).sendFile(__dirname + '/hotlinking-disallowed.png');
  }
  return next();
};
